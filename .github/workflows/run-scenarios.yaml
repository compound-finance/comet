name: Run Scenarios
on:
  workflow_dispatch:
  pull_request:
permissions:
  checks: write

env:
  ETHERSCAN_KEY: ${{ secrets.ETHERSCAN_KEY }}
  ETHERSCAN_KEY_FOR_OPTIMISM: ${{ secrets.ETHERSCAN_KEY_FOR_OPTIMISM }}
  ETHERSCAN_KEY_FOR_BASE: ${{ secrets.ETHERSCAN_KEY_FOR_BASE }}
  ETHERSCAN_KEY_FOR_ARBITRUM: ${{ secrets.ETHERSCAN_KEY_FOR_ARBITRUM }}
  ETHERSCAN_KEY_FOR_POLYGON: ${{ secrets.ETHERSCAN_KEY_FOR_POLYGON }}
  ETHERSCAN_KEY_FOR_LINEA: ${{ secrets.ETHERSCAN_KEY_FOR_LINEA }}
  SNOWTRACE_KEY: ${{ secrets.SNOWTRACE_KEY }}
  INFURA_KEY: ${{ secrets.INFURA_KEY }}
  MAINNET_QUICKNODE_LINK: ${{ secrets.MAINNET_QUICKNODE_LINK }}
  SEPOLIA_QUICKNODE_LINK: ${{ secrets.SEPOLIA_QUICKNODE_LINK }}
  RONIN_QUICKNODE_LINK: ${{ secrets.RONIN_QUICKNODE_LINK }}
  POLYGON_QUICKNODE_LINK: ${{ secrets.POLYGON_QUICKNODE_LINK }}
  OPTIMISM_QUICKNODE_LINK: ${{ secrets.OPTIMISM_QUICKNODE_LINK }}
  MANTLE_QUICKNODE_LINK: ${{ secrets.MANTLE_QUICKNODE_LINK }}
  BASE_QUICKNODE_LINK: ${{ secrets.BASE_QUICKNODE_LINK }}
  ARBITRUM_QUICKNODE_LINK: ${{ secrets.ARBITRUM_QUICKNODE_LINK }}
  _TENDERLY_KEY_POLYGON: ${{ secrets._TENDERLY_KEY_POLYGON }}
  _TENDERLY_KEY_RONIN: ${{ secrets._TENDERLY_KEY_RONIN }}
  POLYGONSCAN_KEY: ${{ secrets.POLYGONSCAN_KEY }}
  BASESCAN_KEY: ${{ secrets.BASESCAN_KEY }}
  OPTIMISMSCAN_KEY: ${{ secrets.OPTIMISMSCAN_KEY }}
  MANTLESCAN_KEY: ${{ secrets.MANTLESCAN_KEY }}
  SCROLLSCAN_KEY: ${{ secrets.SCROLLSCAN_KEY }}
  UNICHAIN_QUICKNODE_LINK: ${{ secrets.UNICHAIN_QUICKNODE_LINK }}
  LINEA_QUICKNODE_LINK: ${{ secrets.LINEA_QUICKNODE_LINK }}

jobs:
  prepare:
    name: Prepare Repository
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Create a deterministic cache key based on yarn.lock
      - name: Cache node_modules (create/save)
        uses: actions/cache@v4
        id: yarn-cache
        with:
          path: |
            node_modules
            .yarn/cache
            .yarn/__virtual__
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      - name: Install packages
        run: yarn install --non-interactive --frozen-lockfile

      - name: Compile
        run: yarn build

      - name: Spider Contracts on Mainnet
        run: yarn hardhat spider --network mainnet --deployment usdc

      # Upload only the prepared artifacts you need (no node_modules)
      - name: Upload prepared state
        uses: actions/upload-artifact@v4
        with:
          name: prepared-data
          path: |
            deployments/**/aliases.json
            deployments/**/.contracts/*.json
            artifacts/
            build/
            cache/
          include-hidden-files: true

  run-scenarios:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        bases: [ development, mainnet, mainnet-weth, mainnet-wbtc, mainnet-usdt, mainnet-wsteth, mainnet-usds, sepolia-usdc, sepolia-weth, fuji, polygon, polygon-usdt, arbitrum-usdc.e, arbitrum-usdc, arbitrum-weth, arbitrum-usdt, base-usdbc, base-weth, base-usdc, base-aero, base-usds, optimism-usdc, optimism-usdt, optimism-weth, mantle-usde, linea-usdc, linea-weth, scroll-usdc, ronin-weth, ronin-wron, unichain-usdc, unichain-weth]
    name: Run scenarios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download prepared state
        uses: actions/download-artifact@v4
        with:
          name: prepared-data
          path: .

      # Restore the same cache created in prepare
      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .yarn/cache
            .yarn/__virtual__
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      # Install only if cache miss (keeps matrix jobs fast)
      - name: Install deps if needed
        run: |
          if [ ! -d node_modules ] || [ ! -f node_modules/.bin ]; then
            echo "node_modules missing — running yarn install"
            yarn install --non-interactive --frozen-lockfile
          else
            echo "node_modules present from cache — skipping install"
          fi

      - name: Run scenarios
        env:
          DEBUG: true
        run: yarn scenario --bases ${{ matrix.bases }}

      - uses: actions/upload-artifact@v4 # upload scenario results
        if: success() || failure() # run this step even if previous step failed
        with:
          name: scenario-results-${{ matrix.bases }}
          path: scenario-results.json

      - uses: dorny/test-reporter@v1
        with:
          name: Scenario Tests (${{ matrix.bases }}) # Name of the check run which will be created
          path: scenario-results.json # Path to test results (inside artifact .zip)
          reporter: mocha-json # Format of test results
