import { expect } from 'chai';
import hre, { ethers } from 'hardhat';
import nock from 'nock';

import {
  Dog,
  ProxyAdmin,
  TransparentUpgradeableProxy,
} from '../../../build/types';

import { getBuildFile } from '../ContractMap';
import { DeploymentManager } from '../DeploymentManager';
import { fiatTokenBuildFile, mockImportSuccess } from './ImportTest';
import { Migration } from '../Migration';
import { expectedTemplate } from './MigrationTemplateTest';
import { buildToken, faucetTokenBuildFile, tokenArgs } from './DeployHelpers';
import { tempDir } from './TestHelpers';
import { VerifyArgs } from '../Verify';
import { getVerifyArgs, putVerifyArgs } from '../VerifyArgs';
import { mockVerifySuccess } from './VerifyTest';
import { objectFromMap } from '../Utils';

export interface TestContracts {
  finn: Dog;
  molly: Dog;
  spot: Dog;
  proxy: TransparentUpgradeableProxy;
  finnImpl: Dog;
  proxyAdmin: ProxyAdmin;
}

export async function setupContracts(deploymentManager: DeploymentManager): Promise<TestContracts> {
  let proxyAdminArgs: [] = [];
  let proxyAdmin: ProxyAdmin = await deploymentManager.deploy(
    'proxyAdmin',
    'vendor/proxy/transparent/ProxyAdmin.sol',
    proxyAdminArgs
  );

  let finnImpl: Dog = await deploymentManager.deploy(
    'finnImpl',
    'test/Dog.sol',
    ['finn:implementation', '0x0000000000000000000000000000000000000000', []]
  );

  let proxy: TransparentUpgradeableProxy = await deploymentManager.deploy(
    'proxy',
    'vendor/proxy/transparent/TransparentUpgradeableProxy.sol',
    [finnImpl.address, proxyAdmin.address, (
      await finnImpl.populateTransaction.initializeDog(
        'finn',
        finnImpl.address,
        []
      )
    ).data]);

  let molly: Dog = await deploymentManager.deploy(
    'molly',
    'test/Dog.sol',
    ['molly', proxy.address, []]
  );

  let spot: Dog = await deploymentManager.deploy(
    'spot',
    'test/Dog.sol',
    ['spot', proxy.address, []]
  );

  let finn = finnImpl.attach(proxy.address);

  await finn.addPup(molly.address);
  await finn.addPup(spot.address);

  return {
    finn,
    molly,
    spot,
    proxy,
    finnImpl,
    proxyAdmin,
  };
}

describe('DeploymentManager', () => {
  beforeEach(async () => {
    nock.disableNetConnect();
  });

  describe('import', () => {
    // Skipping since this test fails a lot due to limits
    //  and import is well-covered as everything else relies upon it
    it.skip('should import succesfully', async () => {
      mockImportSuccess('0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e');
      let deploymentManager = new DeploymentManager('avalanche', 'frax', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });
      let importResult = await deploymentManager.import(
        '0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e',
      );
      expect(importResult).to.eql(fiatTokenBuildFile);
    });
  });

  describe('deploy', () => {
    it('should deploy succesfully', async () => {
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });
      let spot: Dog = await deploymentManager.deploy(
        'spot',
        'test/Dog.sol',
        ['spot', '0x0000000000000000000000000000000000000000', []]
      );
      // Check that we've cached the build file
      expect((await getBuildFile(deploymentManager.cache, 'test-network', spot.address)).contract).to.eql('Dog');
    });
  });

  describe('_deployBuild', () => {
    it('should deployBuild succesfully', async () => {
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });
      let token = await deploymentManager._deployBuild(faucetTokenBuildFile, tokenArgs);
      expect(await token.symbol()).to.equal('TEST');
    });
  });

  describe('verifyContracts', () => {
    it('should verify contracts successfully', async () => {
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });
      // We have to deploy a contract because the Etherscan plugin checks the bytecode at the address
      let token = await buildToken();
      let verifyArgs: VerifyArgs = {
        via: 'artifacts',
        address: token.address,
        constructorArguments: tokenArgs
      };
      await putVerifyArgs(
        deploymentManager.cache,
        token.address,
        verifyArgs
      );
      expect(objectFromMap(await getVerifyArgs(deploymentManager.cache))).to.eql({
        [token.address]: verifyArgs
      });

      mockVerifySuccess(hre);
      await deploymentManager.verifyContracts();

      // VerifyArgs cache should be cleared upon successful verification
      expect(objectFromMap(await getVerifyArgs(deploymentManager.cache))).to.eql({});
    });
  });

  describe('putAlias', () => {
    it('should update contract cache', async () => {
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });
      let spot: Dog = await deploymentManager.deploy(
        'spot',
        'test/Dog.sol',
        ['spot', '0x0000000000000000000000000000000000000000', []]
      );
      let molly: Dog = await deploymentManager.deploy(
        'molly',
        'test/Dog.sol',
        ['molly', '0x0000000000000000000000000000000000000000', []]
      );
      await deploymentManager.putAlias('pet', spot);
      expect(await (await deploymentManager.contract('pet')).name()).to.equal('spot');
      await deploymentManager.putAlias('pet', molly);
      expect(await (await deploymentManager.contract('pet')).name()).to.equal('molly');
    });
  });

  describe('spider', () => {
    it('should spider succesfully', async () => {
      let deploymentManager = new DeploymentManager(
        'test-network',
        'test-deployment',
        hre, {
          importRetries: 0,
          writeCacheToDisk: true,
          baseDir: tempDir(),
        }
      );

      let { finn } = await setupContracts(
        deploymentManager
      );

      hre.config.deploymentManager.networks = {
        'test-network': {
          'test-deployment': {
            finn: {
              delegates: {
                field: {
                  slot: '0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc',
                },
              },
              relations: {
                father: {
                  alias: '.name',
                },
                pups: {
                  field: async (dog) => (await dog.callStatic.puppers()).map(({ pup }) => pup),
                  alias: ['.name'],
                },
              },
            },
          },
        },
      };

      await deploymentManager.spider({ finn });

      let check = {};
      for (let [alias, contract] of await deploymentManager.contracts()) {
        // Just make sure these contracts are working, too.
        let name = contract.hasOwnProperty('name') ? await contract.name() : null;
        check[alias] = name ? name : contract.address;
      }
      expect(check).to.eql({
        finn: 'finn',
        'finn:implementation': 'finn:implementation',
        molly: 'molly',
        spot: 'spot',
      });
    });
  });

  describe('contracts', () => {
    it('should get contracts succesfully', async () => {
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });

      let { finn } = await setupContracts(
        deploymentManager
      );

      await deploymentManager.putAlias('mydog', finn);
      let contracts = await deploymentManager.contracts();

      expect(await contracts.get('mydog').name()).to.eql('finn');
    });
  });

  describe('contract', () => {
    it('should get contract succesfully', async () => {
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });

      let { finn } = await setupContracts(
        deploymentManager
      );

      await deploymentManager.putAlias('mydog', finn);
      let contract = await deploymentManager.contract('mydog');
      expect(await contract.name()).to.eql('finn');
    });
  });

  describe('generateMigration', () => {
    it('should generate expected migration', async () => {
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir: tempDir(),
      });

      expect(await deploymentManager.generateMigration('cool', 1)).to.equal('1_cool.ts');

      expect(
        await deploymentManager.cache.readCache({ rel: ['migrations', '1_cool.ts'] })
      ).to.equal(expectedTemplate);
    });
  });

  describe('storeArtifact & readArtifact', () => {
    it('should store and retrieve a given artifact', async () => {
      let baseDir = tempDir();
      let deploymentManager = new DeploymentManager('test-network', 'test-deployment', hre, {
        importRetries: 0,
        writeCacheToDisk: true,
        baseDir,
      });

      let migration: Migration<null> = {
        name: '1_cool',
        actions: {
          prepare: async () => null,
          enact: async () => { /* */ },
        },
      };

      expect(await deploymentManager.readArtifact(migration)).to.eql(undefined);

      expect(await deploymentManager.storeArtifact(migration, { dog: 'cool' })).to.eql(
        `${baseDir}/test-network/test-deployment/artifacts/1_cool.json`
      );

      expect(await deploymentManager.readArtifact(migration)).to.eql({ dog: 'cool' });

      deploymentManager.cache.clearMemory();

      expect(await deploymentManager.readArtifact(migration)).to.eql({ dog: 'cool' });
    });
  });
  describe.only('Tracer prints output to terminal', ()  => {
    let originalConsoleLog;
    let beforeTestDebugEnv;
    let console_state;
    const interceptor = (...args) => {
      console_state = console_state + args;

    };
    before(() => {
      originalConsoleLog = console.log;
      beforeTestDebugEnv = process.env.DEBUG;
      process.env.DEBUG = 'TRUE';
      console_state = '';
      console.log = interceptor;
    }),
    afterEach(() => {
      console.log = originalConsoleLog;
      process.env.DEBUG = beforeTestDebugEnv;
    });
    beforeEach(() => {console_state = ''; console.log = interceptor;});
    it('should trace ProposalCreated', async () => {
      let dm = new DeploymentManager('test-network', 'test-deployment', hre);
      let dummyTxlLog = `[{"address":"0xc0da02939e1441f497fd74f78ce7decb17b66529","topics":["0x7d84a6263ae0d98d3329bd7b46bb4e8d6f98cd35a7adb45c274c8b7fd5ebd5e0"],"data":"0x00000000000000000000000000000000000000000000000000000000000000ae0000000000000000000000003fb19771947072629c8eee7995a2ef23b72d4c8a000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000011140c90000000000000000000000000000000000000000000000000000000001118dc700000000000000000000000000000000000000000000000000000000000016a00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000866e82a600a1414e583f7f13623f1ac5d58b0afa0000000000000000000000003154cf16ccdb4c6d922629664174b904d80f2c350000000000000000000000004976fb03c32e5b8cfe2b6ccb31c09ba78ebaba410000000000000000000000003d9819210a31b4961b30ef54be2aed79b9c9cd3b000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ac7230489e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000002173656e644d65737361676528616464726573732c62797465732c75696e743332290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000226465706f736974455448546f28616464726573732c75696e7433322c627974657329000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e7365745465787428627974657333322c737472696e672c737472696e67290000000000000000000000000000000000000000000000000000000000000000002d5f736574436f6d7053706565647328616464726573735b5d2c75696e743235365b5d2c75696e743235365b5d2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000d400000000000000000000000000000000000000000000000000000000000000de000000000000000000000000000000000000000000000000000000000000010e00000000000000000000000000000000000000000000000000000000000000ca000000000000000000000000018281dfc4d00905da1aaa6731414eaba843c468a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000002dc6c00000000000000000000000000000000000000000000000000000000000000c2000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000000000000000000000000000000000000000000600000000000000000000000045939657d1ca34a8fa39a924b71d28fe8431e58100000000000000000000000045939657d1ca34a8fa39a924b71d28fe8431e581000000000000000000000000bde8f31d2ddda895264e27dd990fab3dc87b372d000000000000000000000000123964802e6ababbe1bc9547d72ef1b69b00a6b100000000000000000000000042000000000000000000000000000000000000060000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ac7230489e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000001b736574466163746f727928616464726573732c6164647265737329000000000000000000000000000000000000000000000000000000000000000000000000e6736574436f6e66696775726174696f6e28616464726573732c28616464726573732c616464726573732c616464726573732c616464726573732c616464726573732c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e743130342c75696e743130342c75696e743130342c28616464726573732c616464726573732c75696e74382c75696e7436342c75696e7436342c75696e7436342c75696e74313238295b5d2929000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000236465706c6f79416e6455706772616465546f28616464726573732c616464726573732900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020736574526577617264436f6e66696728616464726573732c616464726573732900000000000000000000000000000000000000000000000000000000000000096465706f7369742829000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000197472616e7366657228616464726573732c75696e743235362900000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000004000000000000000000000000046e6b214b524310239732d51387075e0e70970bf00000000000000000000000027c348936400791b7350d80fb81bc61ad68df4ae00000000000000000000000000000000000000000000000000000000000003e000000000000000000000000046e6b214b524310239732d51387075e0e70970bf0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000cc3e7c85bb0ee4f09380e041fee95a0caedd4a020000000000000000000000003cb4653f3b45f448d9100b118b75a1503281d2ee00000000000000000000000042000000000000000000000000000000000000060000000000000000000000009f485610e26b9c0140439f88dc0c7742903bd1cf00000000000000000000000088bb8c109640778d3fb1074bb10a66e31f2c9c170000000000000000000000000000000000000000000000000c7d713b49da00000000000000000000000000000000000000000000000000000064d5a475df8000000000000000000000000000000000000000000000000000086b471e6032da0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c7d713b49da00000000000000000000000000000000000000000000000000000083734dd0b08000000000000000000000000000000000000000000000000000072d49374230d3000000000000000000000000000000000000000000000000000023551d91d5e6800000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000038d7ea4c6800000000000000000000000000000000000000000000000000000000035e55f190900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000056bc75e2d63100000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000010f0cf064dd5920000000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec2200000000000000000000000059e242d352ae13166b4987ae5c990c232f7f7cd600000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000c7d713b49da00000000000000000000000000000000000000000000000000000ce80612991d00000000000000000000000000000000000000000000000000000d87e555900180000000000000000000000000000000000000000000000001969368974c05b00000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000045939657d1ca34a8fa39a924b71d28fe8431e58100000000000000000000000046e6b214b524310239732d51387075e0e70970bf000000000000000000000000000000000000000000000000000000000000004000000000000000000000000046e6b214b524310239732d51387075e0e70970bf0000000000000000000000009e1028f5f1d5ede59748ffcee5532509976840e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000046e6b214b524310239732d51387075e0e70970bf0000000000000000000000000000000000000000000000008ac7230489e800000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000cc3e7c85bb0ee4f09380e041fee95a0caedd4a020000000000000000000000000000000000000000000000000000000000030d400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e07dcf87198fd673716e5a32b206d9379c4fcbad8875073f52bfd0656759bf89ed000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000001376332d6f6666696369616c2d6d61726b65747300000000000000000000000000000000000000000000000000000000000000000000000000000000000000020f7b2231223a5b7b226261736553796d626f6c223a2255534443222c22636f6d657441646472657373223a22307863336436383842363637303334393744414131393231314545646666343766323533383463646333227d2c7b226261736553796d626f6c223a2257455448222c22636f6d657441646472657373223a22307841313735383141394533333536643941383538623738394436384234643836366535393361453934227d5d2c22313337223a5b7b226261736553796d626f6c223a2255534443222c22636f6d657441646472657373223a22307846323532313245363736443146374638394364373266464565363631353866353431323436343435227d5d2c2238343533223a5b7b226261736553796d626f6c223a225553446243222c22636f6d657441646472657373223a22307839633465633736386332383532304235303836306561376131356264373231336139664635386266227d2c7b226261736553796d626f6c223a2257455448222c22636f6d657441646472657373223a22307834366536623231346235323433313032333937333244353133383730373545306537303937306266227d5d2c223432313631223a5b7b226261736553796d626f6c223a2255534443222c22636f6d657441646472657373223a22307841354544424444393634366638644646363036643734343865343134383834433764393035644341227d5d7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000039aa39c021dfbae8fac545936693ac917d5e756300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000020aa4c6b04a71c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000002d00442727aaab000000000000000000000000000000000000000000000000000000000000088f2320496e697469616c697a652063574554487633206f6e20426173650a0a546869732070726f706f73616c2074616b65732074686520676f7665726e616e6365207374657073207265636f6d6d656e64656420616e64206e656365737361727920746f20696e697469616c697a65206120436f6d706f756e64204949492057455448206d61726b6574206f6e20426173653b2075706f6e20657865637574696f6e2c20635745544876332077696c6c20626520726561647920666f72207573652e2053696d756c6174696f6e73206861766520636f6e6669726d656420746865206d61726b6574e28099732072656164696e6573732c206173206d75636820617320706f737369626c652c207573696e6720746865205b436f6d6574207363656e6172696f2073756974655d2868747470733a2f2f6769746875622e636f6d2f636f6d706f756e642d66696e616e63652f636f6d65742f747265652f6d61696e2f7363656e6172696f292e0a0a416c74686f756768207468652070726f706f73616c20736574732074686520656e7469726520636f6e66696775726174696f6e20696e2074686520436f6e666967757261746f722c2074686520696e697469616c206465706c6f796d656e7420616c726561647920686173206d6f7374206f662074686573652073616d6520706172616d657465727320616c7265616479207365742e20546865206e657720706172616d657465727320696e636c7564652073657474696e6720746865207269736b20706172616d6574657273206261736564206f6666206f6620746865205b7265636f6d6d656e646174696f6e732066726f6d204761756e746c657420666f7220426173655d2868747470733a2f2f7777772e636f6d702e78797a2f742f6465706c6f792d636f6d706f756e642d6969692d6f6e2d626173652f343430322f32292061732077656c6c206173207468656972205b6c6174657374207265636f6d6d656e646174696f6e7320666f72207468652057455448206d61726b65745d2868747470733a2f2f7777772e636f6d702e78797a2f742f6761756e746c65742d7265636f6d6d656e646174696f6e732d657468657265756d2d636f6d706f756e642d76332d6574682d7269736b2d706172616d657465722d69722d63757276652d696e63656e746976652d6368616e6765732d382d342d32332f34353635292e2046696e616c6c792c2074686520706172616d657465727320696e636c7564652061206d6f64657374207265616c6c6f636174696f6e206f6620736f6d65206f6620746865207632205553444320626f72726f772d7369646520434f4d5020696e63656e746976657320746f20757365727320696e20746865206e6577206d61726b65742e0a0a467572746865722064657461696c656420696e666f726d6174696f6e2063616e20626520666f756e64206f6e2074686520636f72726573706f6e64696e67205b70726f706f73616c2070756c6c20726571756573745d2868747470733a2f2f6769746875622e636f6d2f636f6d706f756e642d66696e616e63652f636f6d65742f70756c6c2f3739342920616e64205b666f72756d2064697363757373696f6e5d2868747470733a2f2f7777772e636f6d702e78797a2f742f6465706c6f792d636f6d706f756e642d6969692d6f6e2d626173652f34343032292e0a0a0a23232050726f706f73616c20416374696f6e730a0a5468652066697273742070726f706f73616c20616374696f6e2073656e647320612063726f73732d636861696e206d65737361676520746f20426173652c2074726967676572696e67206120736572696573206f6620616374696f6e732e20546865736520616374696f6e732061726520746f207365742074686520436f6d6574466163746f727920666f7220746865206e657720436f6d65742c207365742074686520436f6d657420636f6e66696775726174696f6e2c206465706c6f792061206e657720436f6d657420696d706c656d656e746174696f6e2c2073657420434f4d50206173207468652072657761726420746f6b656e20666f7220746865206465706c6f796d656e742c207772617020736f6d652045544820746f20574554482c20616e64207472616e73666572205745544820746f20746865206357455448763320636f6e747261637420617320696e697469616c2072657365727665732e2054686520696e697469616c20737570706c792073706565642077696c6c20626520323020434f4d502f64617920616e6420626f72726f772073706565642077696c6c206265203020434f4d502f6461792e0a0a546865207365636f6e6420616374696f6e2062726964676573203130204554482066726f6d20746865206d61696e6e65742054696d656c6f636b20746f2074686520426173652054696d656c6f636b2c20746f2062652077726170706564206173205745544820616e642073656564656420617320696e697469616c20726573657276657320746f207468652063574554487633206d61726b65742e0a0a54686520746869726420616374696f6e20757064617465732074686520454e5320545854207265636f7264206076332d6f6666696369616c2d6d61726b65747360206f6e206076332d6164646974696f6e616c2d6772616e74732e636f6d706f756e642d636f6d6d756e6974792d6c6963656e7365732e657468602c207570646174696e6720746865206f6666696369616c206d61726b657473204a534f4e20746f20696e636c75646520746865206e65772042617365206355534462437633206d61726b65742e0a0a54686520666f7572746820616374696f6e20726564756365732074686520434f4d5020646973747269627574696f6e20746f20763220635553444320626f72726f7765727320627920323020434f4d502f6461792c20736f20617320746f206b6565702074686520746f74616c20434f4d5020646973747269627574696f6e20636f6e7374616e742e0000000000000000000000000000000000","blockHash":"0x3396f18726b3d94b3ad2747a936d794332411e9174a4fc7141f7cfc14ded839e","blockNumber":"0x1110d75","transactionHash":"0x3708c3e55e2879c00e6c017c99a0719e98d767a93d62e91d04ad47b02d932993","transactionIndex":"0x6f","logIndex":"0x113","removed":false}]`;
      let t = dm.tracer();
      const fn = {
        wait: async  () => ({
          events : JSON.parse(dummyTxlLog),
          cumulativeGasUsed: ethers.BigNumber.from(1),
          effectiveGasPrice: ethers.BigNumber.from(1),
        })

      };
      await t(fn);
      expect(console_state).to.include('calldata: 0x8a3be80f00000000000000000');
      console.log = originalConsoleLog;
    }
    );
    it('should not trace unknown logs', async () => {
      let dm = new DeploymentManager('test-network', 'test-deployment', hre);
      let dummyTxlLog = `[{"address":"0xc0da02939e1441f497fd74f78ce7decb17b66529","topics":["0x0d84a6263ae0d98d3329bd7b46bb4e8d6f98cd35a7adb45c274c8b7fd5ebd5e0"],"data":"0x00000000000000000000000000000000000000000000000000000000000000ae0000000000000000000000003fb19771947072629c8eee7995a2ef23b72d4c8a000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000011140c90000000000000000000000000000000000000000000000000000000001118dc700000000000000000000000000000000000000000000000000000000000016a00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000866e82a600a1414e583f7f13623f1ac5d58b0afa0000000000000000000000003154cf16ccdb4c6d922629664174b904d80f2c350000000000000000000000004976fb03c32e5b8cfe2b6ccb31c09ba78ebaba410000000000000000000000003d9819210a31b4961b30ef54be2aed79b9c9cd3b000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ac7230489e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000002173656e644d65737361676528616464726573732c62797465732c75696e743332290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000226465706f736974455448546f28616464726573732c75696e7433322c627974657329000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e7365745465787428627974657333322c737472696e672c737472696e67290000000000000000000000000000000000000000000000000000000000000000002d5f736574436f6d7053706565647328616464726573735b5d2c75696e743235365b5d2c75696e743235365b5d2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000d400000000000000000000000000000000000000000000000000000000000000de000000000000000000000000000000000000000000000000000000000000010e00000000000000000000000000000000000000000000000000000000000000ca000000000000000000000000018281dfc4d00905da1aaa6731414eaba843c468a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000002dc6c00000000000000000000000000000000000000000000000000000000000000c2000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000000000000000000000000000000000000000000600000000000000000000000045939657d1ca34a8fa39a924b71d28fe8431e58100000000000000000000000045939657d1ca34a8fa39a924b71d28fe8431e581000000000000000000000000bde8f31d2ddda895264e27dd990fab3dc87b372d000000000000000000000000123964802e6ababbe1bc9547d72ef1b69b00a6b100000000000000000000000042000000000000000000000000000000000000060000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ac7230489e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000001b736574466163746f727928616464726573732c6164647265737329000000000000000000000000000000000000000000000000000000000000000000000000e6736574436f6e66696775726174696f6e28616464726573732c28616464726573732c616464726573732c616464726573732c616464726573732c616464726573732c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e7436342c75696e743130342c75696e743130342c75696e743130342c28616464726573732c616464726573732c75696e74382c75696e7436342c75696e7436342c75696e7436342c75696e74313238295b5d2929000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000236465706c6f79416e6455706772616465546f28616464726573732c616464726573732900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020736574526577617264436f6e66696728616464726573732c616464726573732900000000000000000000000000000000000000000000000000000000000000096465706f7369742829000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000197472616e7366657228616464726573732c75696e743235362900000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000004000000000000000000000000046e6b214b524310239732d51387075e0e70970bf00000000000000000000000027c348936400791b7350d80fb81bc61ad68df4ae00000000000000000000000000000000000000000000000000000000000003e000000000000000000000000046e6b214b524310239732d51387075e0e70970bf0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000cc3e7c85bb0ee4f09380e041fee95a0caedd4a020000000000000000000000003cb4653f3b45f448d9100b118b75a1503281d2ee00000000000000000000000042000000000000000000000000000000000000060000000000000000000000009f485610e26b9c0140439f88dc0c7742903bd1cf00000000000000000000000088bb8c109640778d3fb1074bb10a66e31f2c9c170000000000000000000000000000000000000000000000000c7d713b49da00000000000000000000000000000000000000000000000000000064d5a475df8000000000000000000000000000000000000000000000000000086b471e6032da0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c7d713b49da00000000000000000000000000000000000000000000000000000083734dd0b08000000000000000000000000000000000000000000000000000072d49374230d3000000000000000000000000000000000000000000000000000023551d91d5e6800000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000038d7ea4c6800000000000000000000000000000000000000000000000000000000035e55f190900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000056bc75e2d63100000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000010f0cf064dd5920000000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec2200000000000000000000000059e242d352ae13166b4987ae5c990c232f7f7cd600000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000c7d713b49da00000000000000000000000000000000000000000000000000000ce80612991d00000000000000000000000000000000000000000000000000000d87e555900180000000000000000000000000000000000000000000000001969368974c05b00000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000045939657d1ca34a8fa39a924b71d28fe8431e58100000000000000000000000046e6b214b524310239732d51387075e0e70970bf000000000000000000000000000000000000000000000000000000000000004000000000000000000000000046e6b214b524310239732d51387075e0e70970bf0000000000000000000000009e1028f5f1d5ede59748ffcee5532509976840e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000046e6b214b524310239732d51387075e0e70970bf0000000000000000000000000000000000000000000000008ac7230489e800000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000cc3e7c85bb0ee4f09380e041fee95a0caedd4a020000000000000000000000000000000000000000000000000000000000030d400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e07dcf87198fd673716e5a32b206d9379c4fcbad8875073f52bfd0656759bf89ed000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000001376332d6f6666696369616c2d6d61726b65747300000000000000000000000000000000000000000000000000000000000000000000000000000000000000020f7b2231223a5b7b226261736553796d626f6c223a2255534443222c22636f6d657441646472657373223a22307863336436383842363637303334393744414131393231314545646666343766323533383463646333227d2c7b226261736553796d626f6c223a2257455448222c22636f6d657441646472657373223a22307841313735383141394533333536643941383538623738394436384234643836366535393361453934227d5d2c22313337223a5b7b226261736553796d626f6c223a2255534443222c22636f6d657441646472657373223a22307846323532313245363736443146374638394364373266464565363631353866353431323436343435227d5d2c2238343533223a5b7b226261736553796d626f6c223a225553446243222c22636f6d657441646472657373223a22307839633465633736386332383532304235303836306561376131356264373231336139664635386266227d2c7b226261736553796d626f6c223a2257455448222c22636f6d657441646472657373223a22307834366536623231346235323433313032333937333244353133383730373545306537303937306266227d5d2c223432313631223a5b7b226261736553796d626f6c223a2255534443222c22636f6d657441646472657373223a22307841354544424444393634366638644646363036643734343865343134383834433764393035644341227d5d7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000039aa39c021dfbae8fac545936693ac917d5e756300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000020aa4c6b04a71c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000002d00442727aaab000000000000000000000000000000000000000000000000000000000000088f2320496e697469616c697a652063574554487633206f6e20426173650a0a546869732070726f706f73616c2074616b65732074686520676f7665726e616e6365207374657073207265636f6d6d656e64656420616e64206e656365737361727920746f20696e697469616c697a65206120436f6d706f756e64204949492057455448206d61726b6574206f6e20426173653b2075706f6e20657865637574696f6e2c20635745544876332077696c6c20626520726561647920666f72207573652e2053696d756c6174696f6e73206861766520636f6e6669726d656420746865206d61726b6574e28099732072656164696e6573732c206173206d75636820617320706f737369626c652c207573696e6720746865205b436f6d6574207363656e6172696f2073756974655d2868747470733a2f2f6769746875622e636f6d2f636f6d706f756e642d66696e616e63652f636f6d65742f747265652f6d61696e2f7363656e6172696f292e0a0a416c74686f756768207468652070726f706f73616c20736574732074686520656e7469726520636f6e66696775726174696f6e20696e2074686520436f6e666967757261746f722c2074686520696e697469616c206465706c6f796d656e7420616c726561647920686173206d6f7374206f662074686573652073616d6520706172616d657465727320616c7265616479207365742e20546865206e657720706172616d657465727320696e636c7564652073657474696e6720746865207269736b20706172616d6574657273206261736564206f6666206f6620746865205b7265636f6d6d656e646174696f6e732066726f6d204761756e746c657420666f7220426173655d2868747470733a2f2f7777772e636f6d702e78797a2f742f6465706c6f792d636f6d706f756e642d6969692d6f6e2d626173652f343430322f32292061732077656c6c206173207468656972205b6c6174657374207265636f6d6d656e646174696f6e7320666f72207468652057455448206d61726b65745d2868747470733a2f2f7777772e636f6d702e78797a2f742f6761756e746c65742d7265636f6d6d656e646174696f6e732d657468657265756d2d636f6d706f756e642d76332d6574682d7269736b2d706172616d657465722d69722d63757276652d696e63656e746976652d6368616e6765732d382d342d32332f34353635292e2046696e616c6c792c2074686520706172616d657465727320696e636c7564652061206d6f64657374207265616c6c6f636174696f6e206f6620736f6d65206f6620746865207632205553444320626f72726f772d7369646520434f4d5020696e63656e746976657320746f20757365727320696e20746865206e6577206d61726b65742e0a0a467572746865722064657461696c656420696e666f726d6174696f6e2063616e20626520666f756e64206f6e2074686520636f72726573706f6e64696e67205b70726f706f73616c2070756c6c20726571756573745d2868747470733a2f2f6769746875622e636f6d2f636f6d706f756e642d66696e616e63652f636f6d65742f70756c6c2f3739342920616e64205b666f72756d2064697363757373696f6e5d2868747470733a2f2f7777772e636f6d702e78797a2f742f6465706c6f792d636f6d706f756e642d6969692d6f6e2d626173652f34343032292e0a0a0a23232050726f706f73616c20416374696f6e730a0a5468652066697273742070726f706f73616c20616374696f6e2073656e647320612063726f73732d636861696e206d65737361676520746f20426173652c2074726967676572696e67206120736572696573206f6620616374696f6e732e20546865736520616374696f6e732061726520746f207365742074686520436f6d6574466163746f727920666f7220746865206e657720436f6d65742c207365742074686520436f6d657420636f6e66696775726174696f6e2c206465706c6f792061206e657720436f6d657420696d706c656d656e746174696f6e2c2073657420434f4d50206173207468652072657761726420746f6b656e20666f7220746865206465706c6f796d656e742c207772617020736f6d652045544820746f20574554482c20616e64207472616e73666572205745544820746f20746865206357455448763320636f6e747261637420617320696e697469616c2072657365727665732e2054686520696e697469616c20737570706c792073706565642077696c6c20626520323020434f4d502f64617920616e6420626f72726f772073706565642077696c6c206265203020434f4d502f6461792e0a0a546865207365636f6e6420616374696f6e2062726964676573203130204554482066726f6d20746865206d61696e6e65742054696d656c6f636b20746f2074686520426173652054696d656c6f636b2c20746f2062652077726170706564206173205745544820616e642073656564656420617320696e697469616c20726573657276657320746f207468652063574554487633206d61726b65742e0a0a54686520746869726420616374696f6e20757064617465732074686520454e5320545854207265636f7264206076332d6f6666696369616c2d6d61726b65747360206f6e206076332d6164646974696f6e616c2d6772616e74732e636f6d706f756e642d636f6d6d756e6974792d6c6963656e7365732e657468602c207570646174696e6720746865206f6666696369616c206d61726b657473204a534f4e20746f20696e636c75646520746865206e65772042617365206355534462437633206d61726b65742e0a0a54686520666f7572746820616374696f6e20726564756365732074686520434f4d5020646973747269627574696f6e20746f20763220635553444320626f72726f7765727320627920323020434f4d502f6461792c20736f20617320746f206b6565702074686520746f74616c20434f4d5020646973747269627574696f6e20636f6e7374616e742e0000000000000000000000000000000000","blockHash":"0x3396f18726b3d94b3ad2747a936d794332411e9174a4fc7141f7cfc14ded839e","blockNumber":"0x1110d75","transactionHash":"0x3708c3e55e2879c00e6c017c99a0719e98d767a93d62e91d04ad47b02d932993","transactionIndex":"0x6f","logIndex":"0x113","removed":false}]`;
      let t = dm.tracer();
      const fn = {
        wait: async  () => ({
          events : JSON.parse(dummyTxlLog),
          cumulativeGasUsed: ethers.BigNumber.from(1),
          effectiveGasPrice: ethers.BigNumber.from(1),
        })

      };
      await t(fn);
      expect(console_state).to.include('could not decode event');

    });
  });
});

